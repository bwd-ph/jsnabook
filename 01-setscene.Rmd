# Setting the Scene
## Population
###Population Estimates\
and Projections
#### Mid-2018 Estimates
The latest ONS population estimates _[@ONS_popest]_ are for mid-2018, and show that Blackburn with Darwen had a total of 148,942 residents (an increase of 170 since mid-2017). In Figure \@ref(fig:pyramid) below, the England age structure is superimposed for comparison. This illustrates that Blackburn with Darwen has a much younger age profile than average. 28.4% of its population is aged under 20, which is the 6th highest proportion in England.

(ref:pyramidcap) ONS mid-2018 population estimate for Blackburn with Darwen<br/>(with England profile for comparison)

```{r pyramid, fig.cap='(ref:pyramidcap)', echo=FALSE, out.width='75%',fig.align='center'}
knitr::include_graphics("Assets/p2fig1.png")
```
#### Population Projections 
The latest population projections _[@ONS_popproj]_ are still based on the population estimates for mid-2016, and look ahead to 2041. For Blackburn with Darwen overall, they predict a slow, almost imperceptible fall in population (Figure \@ref(fig:projections)). However, the 65+ age-group (shown in green) is expected to rise by approximately 8,300 over the period - ie. by almost 40%. The 85+ group in particular is projected to rise by over 80%, from approximately 2400 to 4400.

(ref:Projectioncap) _(interactive)_ 2016-based ONS population projections, Blackburn with Darwen

```{r projections, fig.cap='(ref:Projectioncap)', echo=FALSE,message = FALSE, warning = FALSE, out.width='100%', fig.align='center'}
# knitr::include_graphics("Assets/p2fig2.png")
proj <- read.csv("http://www.nomisweb.co.uk/api/v01/dataset/NM_2006_1.data.csv?geography=1870659597&projected_year=2016...2041&gender=0&c_age=200,1,3...18,210,191&measures=20100&select=geography_name,geography_code,projected_year_name,c_age_name,obs_value")

# NB - '85+' in Nomis is inclusive of 90+. We need to change it to '85-89'.

proj85to89 <- proj %>% filter(C_AGE_NAME %in% c('Aged 85+','Aged 90+')) %>%
   spread(C_AGE_NAME,OBS_VALUE) %>% mutate(`Aged 85-89` = `Aged 85+` - `Aged 90+`) %>%
   gather('C_AGE_NAME','OBS_VALUE',4:6) %>%
   filter(C_AGE_NAME == 'Aged 85-89')

proj <- proj %>% filter(C_AGE_NAME != "Aged 85+") %>% bind_rows(proj85to89)

proj_allage <- proj %>% filter(C_AGE_NAME == 'All Ages')
proj <- proj %>% filter(C_AGE_NAME != 'All Ages') # proj just now has each age group once only with no overlap

# Rationalise factor ordering and naming
proj$C_AGE_NAME <- factor(proj$C_AGE_NAME,levels=c("Age 0 - 4","Aged 5-9","Aged 10-14","Aged 15-19",
                                                         "Aged 20-24","Aged 25-29","Aged 30-34","Aged 35-39",
                                                         "Aged 40-44","Aged 45-49","Aged 50-54","Aged 55-59",
                                                         "Aged 60-64","Aged 65-69","Aged 70-74","Aged 75-79",
                                                         "Aged 80-84","Aged 85-89","Aged 90+"))
levels(proj$C_AGE_NAME)[levels(proj$C_AGE_NAME) == "Age 0 - 4"] <- "Aged 0-4"

m <- list(
  l = 200,
  r = 200,
  b = 60,
  t = 50,
  pad = 4
)

pal1 <- brewer.pal(n=6,"Reds")
pal2 <- brewer.pal(n=7,"Blues")
pal3 <- brewer.pal(n=6,"Greens")
mypal <- c(pal1,pal2,pal3)

proj %>% group_by(PROJECTED_YEAR_NAME) %>% arrange(C_AGE_NAME) %>% 
  mutate(cum_pop = cumsum(OBS_VALUE)) %>%
  plot_ly(width = 800, height = 700,type = 'scatter', x = ~PROJECTED_YEAR_NAME, y = ~cum_pop, color = ~C_AGE_NAME, colors = mypal,mode = 'lines', fill = 'tonexty',alpha = 1,
          hoverinfo = "x+name+text",
          text = ~paste("<b>",round(OBS_VALUE)," persons</b>")) %>%
  layout(margin = m,xaxis = list(title = "Year",tickfont = list(size = 15),titlefont = list(size = 18)),
         yaxis = list(title = "Projected Population",tickfont = list(size = 15),titlefont = list(size = 18)),
         hovermode = 'compare',legend = list(x = -0.55,y=0,font = list(size = 15)))
```
### 2011 Census Data
#### Ethnicity
The 2011 Census _[@Nomis]_ is still our best source of data on the ethnic breakdown of the borough’s population, and the relationship between ethnic group and other social characteristics. The proportion of Blackburn with Darwen residents who described themselves as Indian or Pakistani are the 11th highest and the 6th highest respectively of any local authority in England.

(ref:ethcap) Ethnicity: Blackburn with Darwen v. NW and England, 2011<br/>(showing counts for Blackburn with Darwen)

```{r ethnicity, fig.cap='(ref:ethcap)', echo=FALSE,out.width='80%', fig.align='center'}
knitr::include_graphics("Assets/p3fig3.png")
```
The main ethnic groups have markedly different age profiles from each other (Figure \@ref(fig:ethpyramids), and are represented in varying concentrations across the borough (Figure \@ref(fig:ethmaps)).

(ref:ethpyrcap) Age profiles by ethnic group,<br/>Blackburn with Darwen, 2011

```{r ethpyramids, fig.cap='(ref:ethpyrcap)', echo=FALSE,out.width='75%', fig.align='center'}
knitr::include_graphics("Assets/p3fig4.png")
```
&nbsp;
```{r ethmaps, fig.cap='Blackburn with Darwen - ethnicity by ward', echo=FALSE,out.width='80%', fig.align='center'}
knitr::include_graphics("Assets/p3fig5.png")
```
#### Religion
At the 2011 Census, 77,599 Blackburn with Darwen residents (52.6%) identified themselves as Christian, and 39,817 (27.0%) as Muslim. 13.8% had no religion, and 5.6% did not answer the question. Religion and ethnicity are closely interlinked, with the vast majority of Christians in the borough being White, and almost all Muslims being Indian, Pakistani or members of other minority ethnic groups (Figure \@ref(fig:religion)).
```{r religion, fig.cap='Relationship between ethnicity and religion in Blackburn with Darwen', echo = FALSE, out.width = '60%', fig.align='center'}
knitr::include_graphics("Assets/p4fig6.png")
```
#### Language
For the first time, the 2011 Census asked about the ‘main language’ of everybody 
aged 3 or above. Over 86% of Blackburn with Darwen residents had English as their main language, but a multitude of other languages were also represented:
```{r language, fig.cap='Main language of Blackburn with Darwen residents aged 3+', echo = FALSE, out.width = '60%', fig.align='center'}
knitr::include_graphics("Assets/p4fig7.png")
```
Out of 57,353 households in Blackburn with Darwen, there were just over 4,000 where nobody had English as their main language, and just over 800 more where only children did:
&nbsp;
```{r language2, fig.cap='Main language by household', echo = FALSE, out.width = '60%', fig.align='center'}
knitr::include_graphics("Assets/p4fig8.png")
```
However, it is important to appreciate that many of those with a main language other than English nevertheless speak English ‘well’ or ‘very well’. Only 973 people in the borough could not speak it at all.

### Deprivation
The 2015 Index of Mutiple Deprivation _[@MHCLG2015]_ is still in use in 2018 (but expected to be replaced in Summer 2019). It is based on 37 indicators, mostly dating from around 2012/13.

#### Deprivation at the Lower Super Output Area (LSOA) level
The Index of Multiple Deprivation (IMD) is calculated for small neighbourhoods known as Lower Super Output Areas (LSOAs). Figure \@ref(fig:IMDmap) shows IMD 2015 mapped for Blackburn with Darwen’s 91 LSOAs. Nearly half (45 out of 91, or 49%) of the Borough’s LSOAs are in the worst two national deciles. By definition, each national decile accounts for 10% of all the LSOAs in England, so Blackburn with Darwen has well over its ‘fair share’ of deprived LSOAs.
```{r IMDmap, fig.cap='Index of Multiple Deprivation (IMD) 2015', echo = FALSE, out.width = '60%', fig.align='center'}
knitr::include_graphics("Assets/p5fig9.png")
```
#### Deprivation at the Borough level
There are various ways of summarising deprivation at the borough level. For example, the ‘Rank of Average Score’ method ranks authorities according to the average IMD score of their LSOAs. On that basis, Blackburn with Darwen ranks as 15th most deprived in 2015.

However, the summary indicator which is now most widely quoted is the proportion of LSOAs in the borough falling within the 10% most deprived in England (i.e. in National Decile 1). In Blackburn with Darwen, that proportion was 31% in 2015, which makes it the 12th most deprived borough. 

### Destitution
‘Destitution’ is a strong word, but the Joseph Rowntree Foundation estimates that over 1.5 million people in the UK were affected in this way at some point during  2017 _[@JRF2018]_. It defines ‘destitution’ as being on an extremely low income, and/or unable to afford two or more of the listed essentials over the past month:

* Shelter (had slept rough for 1+ nights
* Food (have had < 2 meals a day for 2+ days)
* Heating (have been unable to heat their home for 5+ days)
* Lighting (have been unable to light their home for 5+ days)
* Clothing and footwear (appropriate for weather)
* Basic toiletries (soap, shampoo, toothpaste, toothbrush)

A survey of crisis service users in various parts of the country was used to produce modelled estimates for every local authority. Authorities are ranked on their estimated destitution levels for each of three separate sub-populations (‘migrants’, ‘complex needs’ and ‘other’), and for all three groups put together. Blackburn with Darwen is in the most severe decile of destitution for two out of the three individual sub-populations. It just escapes being in the top decile for destitution overall, but only by one place _[@HW2018]_. 

![](Assets/p5_unnumbered.png)

### Life Expectancy
```{block2, type = 'newstuff'}
This section contains updated material 
&nbsp;
<div style="text-align: right;font-size:80%;"><em>[‘Sparkling’](https://thenounproject.com/term/sparkling/1200272) icon by Morten Halvorsen from [The Noun Project](https://thenounproject.com)</em></div>
```
Life expectancy in Blackburn with Darwen not only lags behind England (see shaded areas in Figure \@ref(fig:LEtrend)), but has plateaued in recent years for males, and actually fallen significantly since 2012-14 for females. In 2015-17, the borough had the 5th lowest life expectancy in England for females, and the 9th equal lowest for males, out of 324 lower-tier local authorities.

(ref:LEtrendcap) _(interactive)_ Life expectancy in England and Blackburn with Darwen

```{r LEtrend, fig.cap='(ref:LEtrendcap)', echo=FALSE,message = FALSE,out.width='85%', fig.align='center'}
# knitr::include_graphics("Assets/p6fig10.png")

BwDData <- fingertips_data(IndicatorID = 90366,AreaTypeID = 102,AreaCode = "E06000008",categorytype = TRUE) %>% 
  filter(Age == "All ages", is.na(CategoryType)) 
BwDData <- transmute(BwDData,`Area Codes` = AreaCode,period = paste(str_sub(Timeperiod,1,4),str_sub(Timeperiod,8,9),sep = "-"), LE = Value, Sex = if_else(Sex == "Male","M","F"))

EngData <- fingertips_data(IndicatorID = 90366,AreaCode = "E92000001",categorytype = TRUE) %>% 
  filter(Age == "All ages", is.na(CategoryType)) 
EngData <- transmute(EngData,`Area Codes` = AreaCode,period = paste(str_sub(Timeperiod,1,4),str_sub(Timeperiod,8,9),sep = "-"), LE = Value, Sex = if_else(Sex == "Male","M","F"))

LE <- bind_rows(BwDData,EngData) %>%
  mutate(LE = as.numeric(LE)) %>%
  mutate(linewidth = if_else(`Area Codes` == "E92000001",1,1.5)) %>%
  rename(Area = `Area Codes`) %>%
  mutate(Area = if_else(Area == "E92000001","England","BwD"))

LE <- unite(LE,"allgroups",Sex,Area) %>% select(allgroups,period,LE) %>% spread(allgroups,LE)

m <- list(
  l = 150,
  r = 50,
  b = 120,
  t = 60,
  pad = 4
)

p <- plot_ly(LE,x = ~period,y = ~F_England,name = "England Female",legendgroup = 'group1',type = 'scatter', mode = 'lines', 
             line = list(color = "Green",width = 1)) %>%
     add_trace(y = ~F_BwD,name = "BwD Female",fill = 'tonexty', fillcolor = 'rgba(252, 201, 252, 0.4)',legendgroup = 'group1',line = list(color = "Blue", width = 2.5)) %>%
     add_trace(y = ~M_England,name = "England Male",legendgroup = 'group2',line = list(color = "Green", width = 1)) %>%
     add_trace(y = ~M_BwD,name = "BwD Male",fill = 'tonexty', fillcolor = 'rgba(166, 209, 251, 0.4)',legendgroup = 'group2',line = list(color = "Blue",width = 2.5)) %>%
  add_annotations(
       x=2,
       y=80,
       xref = "x",
       yref = "y",
       text = "<b>F</b>",
       xanchor = 'center',
       showarrow = F,
       font = list(color = "#EE799F",size=20)
      ) %>%
     add_annotations(
       x=2,
       y=75.5,
       xref = "x",
       yref = "y",
       text = "<b>M</b>",
       xanchor = 'center',
       showarrow = F,
       font = list(color = "#6699CC",size=20)
      ) %>%
     add_annotations(
       x = 0.5,
       y = 1,
       xref = "paper",
       yref = "paper",
       text = "<span style='color:green'>England</span> v. <span style='color:blue'>Blackburn with Darwen</span>",
       font = list(size=16),
       showarrow = F,
       yanchor = "bottom"
     ) %>%
     layout(showlegend = FALSE, margin = m, xaxis = list(title = "",tickangle = 90), yaxis = list(title = "Life Expectancy (years)", hoverformat = '.1f'))
p
```
Even at a national level (green lines in Figure \@ref(fig:LEtrend)), the rate of improvement in life expectancy is much slower than it was. There are also widening inequalities between more and less deprived areas of England, with female life expectancy in the most deprived areas actually falling. In a report on these changing trends, Public Health England concludes that they are likely to be due to a number of factors rather than any single cause _[@PHE_morttrend]_.

```{r echo = FALSE, warning = FALSE, message = FALSE}
LEDepData <- fingertips_data(IndicatorID = 90366,AreaTypeID = 102,AreaCode = "E06000008",categorytype = TRUE) %>% 
  filter(CategoryType == "LSOA11 deprivation deciles within area (IMD2015)") 
latest_date <- max(LEDepData$TimeperiodSortable)
LEDepData <- filter(LEDepData,TimeperiodSortable == latest_date)
latest_period <- first(LEDepData$Timeperiod)

LEDepData$Category <- factor(LEDepData$Category,levels = c("Most deprived decile","Second most deprived decile","Third more deprived decile","Fourth more deprived decile",
                                                 "Fifth more deprived decile","Fifth less deprived decile","Fourth less deprived decile","Third less deprived decile",
                                                 "Second least deprived decile","Least deprived decile"))
levels(LEDepData$Category)[levels(LEDepData$Category)=="Third more deprived decile"] <- "Third most deprived decile"
levels(LEDepData$Category)[levels(LEDepData$Category)=="Fourth more deprived decile"] <- "Fourth most deprived decile"
levels(LEDepData$Category)[levels(LEDepData$Category)=="Fifth more deprived decile"] <- "Fifth most deprived decile"
levels(LEDepData$Category)[levels(LEDepData$Category)=="Third less deprived decile"] <- "Third least deprived decile"
levels(LEDepData$Category)[levels(LEDepData$Category)=="Fourth less deprived decile"] <- "Fourth least deprived decile"
levels(LEDepData$Category)[levels(LEDepData$Category)=="Fifth less deprived decile"] <- "Fifth least deprived decile"

# plotly version
male <- filter(LEDepData,Sex == "Male")
male$fv <- male %>% lm(Value ~ as.integer(Category),.) %>% fitted.values()
male$hiarm <- male$UpperCI95.0limit - male$Value
male$loarm <- male$Value - male$LowerCI95.0limit
male$mytext <- paste(male$Category,": ",round(male$Value,1)," years",sep="")
malecontrast <- male$Value[levels(male$Category)=="Least deprived decile"] - male$Value[levels(male$Category)=="Most deprived decile"]
malecontrast <- round(malecontrast,1)

female <- filter(LEDepData,Sex == "Female")
female$fv <- female %>% lm(Value ~ as.integer(Category),.) %>% fitted.values()
female$hiarm <- female$UpperCI95.0limit - female$Value
female$loarm <- female$Value - female$LowerCI95.0limit
female$mytext <- paste(female$Category,": ",round(female$Value,1)," years",sep="")
femalecontrast <- female$Value[levels(female$Category)=="Least deprived decile"] - female$Value[levels(female$Category)=="Most deprived decile"]
femalecontrast <- round(femalecontrast,1)

```
There is also striking inequality in life expectancy _within_ Blackburn with Darwen (Figure \@ref(fig:slopechart)). To illustrate this, Public Health England has ranked the borough’s LSOAs by IMD score, divided them into ten equal groups (‘deciles’) of deprivation, and calculated the life expectancy for each _[@PHE_download]_.  Allowing for rounding error, the difference between the most and least deprived tenths of the borough was `r malecontrast` years for males in `r latest_period`. For females, it was `r femalecontrast` years.

(ref:slopecap) _(interactive)_ Life expectancy by deprivation decile<br/>(showing 95% confidence intervals)<br/>Blackburn with Darwen, `r latest_period`

```{r slopechart, fig.cap='(ref:slopecap)', echo=FALSE,out.width='85%', fig.align='center'}
#knitr::include_graphics("Assets/p6fig11.png")

m <- list(
  l = 150,
  r = 50,
  b = 120,
  t = 60,
  pad = 4
)

p1 <- plot_ly(male,x = ~Category) %>%
  add_trace(y = ~fv, type = 'scatter',mode = 'lines',showlegend = FALSE,line = list(color = "Gray",width = 1,dash = 'dot'), hoverinfo = 'none') %>%
  add_trace(y = ~Value, text = ~mytext, hoverinfo = "text", name = "Male", type = 'scatter',mode = 'markers', marker = list(color = "#66B2FF",size = 15),
            error_y = list(symmetric = FALSE,array = ~hiarm,arrayminus = ~loarm, type = "bar", color = "#0066CC")) %>%
  layout(xaxis = list(title = "",tickangle = 90))
p2 <- plot_ly(female,x = ~Category) %>%
  add_trace(y = ~fv, type = 'scatter',mode = 'lines',showlegend = FALSE,line = list(color = "Gray",width = 1,dash = 'dot'), hoverinfo = 'none') %>%
  add_trace(y = ~Value, text = ~mytext, hoverinfo = "text", name = "Female", type = 'scatter',mode = 'markers', marker = list(color = "#FF99CC",size = 15),
            error_y = list(symmetric = FALSE,array = ~hiarm,arrayminus = ~loarm, type = "bar", color = "#CC0066")) %>%
  layout(xaxis = list(title = "",tickangle = 90))
p <- subplot(p1,p2, shareY=TRUE) %>%
  layout(margin = m, yaxis = list(title = "Life Expectancy (years)", tickfont = list(size = 15)),legend = list(orientation = 'h', xanchor = "center",yanchor = "bottom",x=0.5,y=1,bgcolor = "#F5F5F5",font = list(size = 20)))
p
```

### Premature Mortality
```{block2, type = 'newstuff'}
This section contains updated material 
&nbsp;
<div style="text-align: right;font-size:80%;"><em>[‘Sparkling’](https://thenounproject.com/term/sparkling/1200272) icon by Morten Halvorsen from [The Noun Project](https://thenounproject.com)</em></div>
```
The inequalities between more and less deprived parts of the borough are also illustrated in the PHE Health Profile for Blackburn with Darwen _[@PHE_HP]_.  The gap in premature death rates is particularly stark for men:

(ref:premcap) _(interactive)_ Premature mortality (under 75, Male & Female)<br/>for England, Blackburn with Darwen,<br/>& most/least deprived quintiles of Blackburn with Darwen

```{r premchart, fig.cap='(ref:premcap)', echo=FALSE,out.width='95%', fig.align='center'}
#knitr::include_graphics("Assets/p6fig12.png")

BwDData <- fingertips_data(IndicatorID = 108,AreaTypeID = 102,AreaCode = "E06000008",categorytype = TRUE) %>%
  filter(Sex != "Persons")
latest_date <- max(BwDData[!is.na(BwDData$Category),]$TimeperiodSortable) # Don't want latest year if they haven't yet got round to
                                                                          # doing inequalities data for it
BwDData <- filter(BwDData,TimeperiodSortable <= latest_date)

EngData <- fingertips_data(IndicatorID = 108,AreaCode = "E92000001",categorytype = TRUE) %>%
  filter(Sex != "Persons",TimeperiodSortable <= latest_date, is.na(CategoryType))

PM <- bind_rows(BwDData,EngData) %>%
  transmute(Area = if_else(AreaCode == "E92000001","England","BwD"), Category, period = paste(str_sub(Timeperiod,1,4),str_sub(Timeperiod,8,9),sep = "-"), 
            DSR = round(Value,1), Sex = if_else(Sex == "Male","M","F") )

male <- filter(PM,Sex == "M") %>% unite("allgroups",Area,Category) %>% select(allgroups,period,DSR) %>% spread(allgroups,DSR)
female <- filter(PM,Sex == "F") %>% unite("allgroups",Area,Category) %>% select(allgroups,period,DSR) %>% spread(allgroups,DSR)

m <- list(
  l = 100,
  r = 150,
  b = 120,
  t = 60,
  pad = 4
)

p1 <- plot_ly(male,x = ~period,y = ~`BwD_Most deprived quintile`,name = "BwD",text = ~ paste("<em>Most Deprived Quintile</em><br />",period,"<br />","Rate: <b>", `BwD_Most deprived quintile`,'</b>',""),type = 'scatter', mode = 'lines+markers', 
             line = list(color = "Blue",width = 1), marker = list(size = 5, color = "Blue"), fill = 'tozeroy',fillcolor = 'rgba(0,0,255, 0.1)',hoverinfo = "text+name") %>%
      add_trace(y = ~`BwD_Least deprived quintile`,name = "BwD",text = ~ paste("<em>Least Deprived Quintile</em><br />",period,"<br />","Rate: <b>",`BwD_Least deprived quintile`,'</b>',""),type = 'scatter', mode = 'lines+markers', 
                line = list(color = "Blue",width = 1,dash = 'dot'),marker = list(size = 5, color = "Blue"), fill = 'tozeroy',fillcolor = 'rgb(255, 255, 255)',hoverinfo = "text+name") %>%
      add_trace(y = ~BwD_NA, name = "BwD",text = ~ paste("<em>Overall</em><br />",period,"<br />","Rate: <b>", BwD_NA,'</b>',""),type = 'scatter', mode = 'lines+markers', line = list(color = "Blue",width = 2), marker = list(size = 10, color = "Blue"), fill = 'none',hoverinfo = "text+name") %>%
      add_trace(y = ~England_NA, name = "England",text = ~ paste(period,"<br />","Rate: <b>", England_NA,'</b>',""),type = 'scatter', mode = 'lines+markers', line = list(color = "Green",width = 1.5), marker = list(size = 7, color = "Green"), fill = 'none',hoverinfo = "text+name") %>%
      add_annotations(
        x=0.15,
        y=850,
        xref = "paper",
        yref = "y",
        text = "<b>M</b>",
        xanchor = 'center',
        showarrow = F,
        font = list(color = "#6699CC",size=20)
      ) %>%
     layout(showlegend = FALSE, xaxis = list(showgrid = FALSE,zeroline = FALSE, showline = FALSE, title = "",tickangle = 90,tickfont = list(size = 15)))

p2 <- plot_ly(female,x = ~period,y = ~`BwD_Most deprived quintile`,name = "BwD",text = ~ paste("<em>Most Deprived Quintile</em><br />",period,"<br />","Rate: <b>", `BwD_Most deprived quintile`,'</b>',""),type = 'scatter', mode = 'lines+markers', 
              line = list(color = "Blue",width = 1), marker = list(size = 5, color = "Blue"), fill = 'tozeroy',fillcolor = 'rgba(252, 201, 252, 0.4)',hoverinfo = "text+name") %>%
      add_trace(y = ~`BwD_Least deprived quintile`,name = "BwD",text = ~ paste("<em>Least Deprived Quintile</em><br />",period,"<br />","Rate: <b>",`BwD_Least deprived quintile`,'</b>',""),type = 'scatter', mode = 'lines+markers', 
            line = list(color = "Blue",width = 1,dash = 'dot'),marker = list(size = 5, color = "Blue"), fill = 'tozeroy',fillcolor = 'rgb(255, 255, 255)',hoverinfo = "text+name") %>%
      add_trace(y = ~BwD_NA, name = "BwD",text = ~ paste("<em>Overall</em><br />",period,"<br />","Rate: <b>", BwD_NA,'</b>',""),type = 'scatter', mode = 'lines+markers', line = list(color = "Blue",width = 2), marker = list(size = 10, color = "Blue"), fill = 'none',hoverinfo = "text+name") %>%
      add_trace(y = ~England_NA, name = "England",text = ~ paste(period,"<br />","Rate: <b>", England_NA,'</b>',""),type = 'scatter', mode = 'lines+markers', line = list(color = "Green",width = 1.5), marker = list(size = 7, color = "Green"), fill = 'none',hoverinfo = "text+name") %>%
      add_annotations(x = 0.95,y = female[nrow(female),]$`BwD_Most deprived quintile`,xref = "paper",yref = "y",text = " Most deprived<br> quintile of BwD",xanchor = "left",yanchor = "bottom",showarrow = F,font = list(color = "Blue",size = 12)) %>%
      add_annotations(x = 0.95,y = female[nrow(female),]$`BwD_NA`,xref = "paper",yref = "y",text = sprintf(" <b>BwD overall</b>"),xanchor = "left",yanchor = "middle",showarrow = F,font = list(color = "Blue",size = 15)) %>%
      add_annotations(x = 0.95,y = female[nrow(female),]$`England_NA`,xref = "paper",yref = "y",text = " England",xanchor = "left",yanchor = "middle",showarrow = F,font = list(color = "Green",size = 15)) %>%
      add_annotations(x = 0.95,y = female[nrow(female),]$`BwD_Least deprived quintile`,xref = "paper",yref = "y",text = " Least deprived<br> quintile of BwD",xanchor = "left",yanchor = "top",showarrow = F,font = list(color = "Blue",size = 12)) %>%
      add_annotations(
        x=0.15,
        y=550,
        xref = "paper",
        yref = "y",
        text = "<b>F</b>",
        xanchor = 'center',
        showarrow = F,
        font = list(color = "#EE799F",size=20)
      ) %>%
      layout(showlegend = FALSE, xaxis = list(showgrid = FALSE,zeroline = FALSE, showline = FALSE, title = "",tickangle = 90,tickfont = list(size = 15)))

p <- subplot(p1,p2, shareY=TRUE) %>%
      layout(margin = m, yaxis = list(showgrid = FALSE,zeroline = FALSE, showline = FALSE,tickfont = list(size = 15), tickprefix = "  ",title = "Directly Standardised Rate per 100,000",titlefont = list(size = 18)))
p
```

## Local Economy
Any analysis of health and social care needs would be incomplete without a quick introduction to the local economy, not only because it helps to set the context, but also because the economy is a major determinant of health. 

### Skills
```{block2, type = 'newstuff'}
This section contains updated material 
&nbsp;
<div style="text-align: right;font-size:80%;"><em>[‘Sparkling’](https://thenounproject.com/term/sparkling/1200272) icon by Morten Halvorsen from [The Noun Project](https://thenounproject.com)</em></div>
```
```{r echo = FALSE, warning = FALSE, message = FALSE}
# Read in data for last 4 quarters, then filter to find the one for which qualifications data is not missing (i.e. the January-December one)
qualsEmp <- read.csv("http://www.nomisweb.co.uk/api/v01/dataset/NM_17_5.data.csv?geography=2092957699,1816133633...1816133837&date=latest,latestMINUS1,latestMINUS2,latestMINUS3&variable=45,344&measures=20599,21001,21002,21003&select=date_name,geography_name,geography_code,variable_name,measures_name,obs_value,obs_status_name")
qualsEmp <- qualsEmp %>% filter(substr(as.character(DATE_NAME),10,12) == "Dec")

bwdNoquals <- qualsEmp %>% filter(GEOGRAPHY_NAME == "Blackburn with Darwen" & VARIABLE_NAME == "% with no qualifications (NVQ) - aged 16-64" & MEASURES_NAME == "Numerator") %>%
  select(OBS_VALUE) %>% pull()
bwdNoquals <- as.integer(bwdNoquals) # don't want it to show as scientific notation
bwdNoqualspc <- qualsEmp %>% filter(GEOGRAPHY_NAME == "Blackburn with Darwen" & VARIABLE_NAME == "% with no qualifications (NVQ) - aged 16-64" & MEASURES_NAME == "Variable") %>%
  select(OBS_VALUE) %>% pull()
EngNoqualspc <- qualsEmp %>% filter(GEOGRAPHY_NAME == "England" & VARIABLE_NAME == "% with no qualifications (NVQ) - aged 16-64" & MEASURES_NAME == "Variable") %>%
  select(OBS_VALUE) %>% pull()
yearending <- substr(as.character(first(qualsEmp$DATE_NAME)),10,17)

qualsEmp <- qualsEmp %>% filter(substr(GEOGRAPHY_CODE,1,1) == "E" & GEOGRAPHY_CODE != "E92000001") %>%
  filter(MEASURES_NAME == "Variable") %>%
  spread(key = VARIABLE_NAME, value = OBS_VALUE) %>%
  drop_na() %>%
  mutate(mytext = paste(GEOGRAPHY_NAME,"\n","% No quals = ",`% with no qualifications (NVQ) - aged 16-64`,"%",
                      "\n","Employment Rate = ",`Employment rate - aged 16-64`,"%",sep = ""),
         BwD = factor(GEOGRAPHY_NAME == "Blackburn with Darwen"),
         NoQualRank = rank(-`% with no qualifications (NVQ) - aged 16-64`))
utlas <- nrow(qualsEmp)
BwDrank <- qualsEmp %>% filter(GEOGRAPHY_NAME == "Blackburn with Darwen") %>% select(NoQualRank) %>% pull()
BwDrank <- toOrdinal(floor(BwDrank))
```
In the year to `r yearending`, there were estimated to be `r bwdNoquals` people aged 16-64 in Blackburn with Darwen with no qualifications, or `r bwdNoqualspc`% of the working-age population (England `r EngNoqualspc`%) _[@Nomis]_.  Clearly such a high rate (ranking `r BwDrank` among `r utlas` upper-tier authorities) is undesirable. Data from Nomis provides a stark illustration of the relationship between lack of qualifications and the employment rate (Figure \@ref(fig:skillchart)) _[@Nomis]_.

(ref:skillcap) _(interactive)_ Relationship between employment rate<br/>and lack of qualifications (year to `r yearending`)<br/><span style='color:blue'>Blackburn with Darwen</span> v. other Upper-Tier Authorities in England _[@Nomis]_.

```{r skillchart, fig.cap='(ref:skillcap)', echo=FALSE,warning = FALSE, message = FALSE,out.width='90%', fig.align='center'}
# knitr::include_graphics("Assets/p7fig13.png")
pal <- c("lightskyblue","blue")

xx <- list(
  title = "% No Qualifications",
  ticksuffix = "%",
  tickfont = list(size = 14),
  titlefont = list(size = 18)
)
yx <- list(
  title = "Employment Rate",
  ticksuffix = "%",
  tickprefix = "  ",
  tickfont = list(size = 14),
  titlefont = list(size = 18)
)

m <- list(
  l = 50,
  r = 50,
  b = 50,
  t = 50,
  pad = 4
)

fv <- lm(`Employment rate - aged 16-64` ~ `% with no qualifications (NVQ) - aged 16-64`,data = qualsEmp) %>% fitted.values()

p <- qualsEmp %>%
  plot_ly(width = 700, height = 700, x = ~`% with no qualifications (NVQ) - aged 16-64`,y = ~`Employment rate - aged 16-64`,color = ~ BwD) %>%
  add_markers(colors = pal,marker = list(size = 12),
             text = ~ paste("<b>",GEOGRAPHY_NAME,"</b><br />",
                            "% No Quals: <b>",`% with no qualifications (NVQ) - aged 16-64`,'%</b>',"<br />",
                            "Employment Rate: <b>",`Employment rate - aged 16-64`,'%</b>'), hoverinfo = "text") %>%
  add_trace(x = ~`% with no qualifications (NVQ) - aged 16-64`,y = fv,mode = "lines", line = list(color = "black")) %>%
  layout(xaxis = xx, yaxis = yx, margin = m,showlegend = FALSE,
         legend = list(x = 0.1, y = 0.9)
  ) 
p
```

```{r echo = FALSE, warning = FALSE, message = FALSE}
# Want the most recent Jan-Dec period, as only they have qualifications data
degree <- read.csv("http://www.nomisweb.co.uk/api/v01/dataset/NM_17_5.data.csv?geography=2092957699,1816133633...1816133837&date=latestMINUS3-latest&variable=1072&measures=20599,21001,21002,21003&select=date_name,geography_name,geography_code,variable_name,measures_name,obs_value,obs_status_name")
degree <- degree %>% filter(substr(as.character(DATE_NAME),10,12) == "Dec")

BwDdegreepc <- degree %>% filter(GEOGRAPHY_NAME == "Blackburn with Darwen" & MEASURES_NAME == "Variable") %>% select(OBS_VALUE) %>% pull()
Engdegreepc <- degree %>% filter(GEOGRAPHY_NAME == "England" & MEASURES_NAME == "Variable") %>% select(OBS_VALUE) %>% pull()
yearending <- substr(as.character(first(degree$DATE_NAME)),10,17)

degree <- degree %>% filter(substr(GEOGRAPHY_CODE,1,1) == "E" & GEOGRAPHY_CODE != "E92000001") %>%
  filter(MEASURES_NAME == "Variable") %>%
  drop_na() %>%
  mutate(degreeRank = rank(OBS_VALUE))
utlas <- nrow(degree)
BwDrank <- degree %>% filter(GEOGRAPHY_NAME == "Blackburn with Darwen") %>% select(degreeRank) %>% pull()
BwDrank <- toOrdinal(floor(BwDrank))
```
At the other end of the spectrum, `r BwDdegreepc`% of people aged 16-64 in Blackburn with Darwen had a degree or equivalent in the year ending `r yearending`. This is still well below average (England `r Engdegreepc`%), and ranks `r BwDrank` lowest out of `r utlas` upper-tier authorities, but it continues a gradually improving trend _[@Nomis]_. 

The proportion of the borough’s 19-year-olds qualified to Level 3 (i.e. two A-levels or equivalent) has also shown steady improvement over the years (Figure \@ref(fig:qual19chart)) _[@DfE_age19]_. 

(ref:qual19cap) _(interactive)_ Level 3 qualification at age 19 _[@DfE_age19]_.

```{r qual19chart, fig.cap='(ref:qual19cap)', echo = FALSE, message = FALSE, warning = FALSE,out.width = '90%', fig.align='center'}
# knitr::include_graphics("Assets/p7fig14.png")

### **** NB **** - EACH YEAR, GO TO https://department-for-education.shinyapps.io/attainment-age-19/, 
### 'Data and methods' tab, and download the latest
### data file (la_underlying_data.csv) to the 'Assets' subdirectory

quals19 <- read.csv("./Assets/la_underlying_data.csv", stringsAsFactors = FALSE)

level3age19 <- quals19 %>% filter(la_name == "Blackburn with Darwen"| (region == "j.England" & la_name == "ALL") | (region == "b.North West" & la_name == "ALL")) %>%        
  filter(gender == "a.ALL" & sen == "a.ALL" & fsm == "a.ALL") %>% 
  mutate(area = ifelse(la_name == "Blackburn with Darwen","BwD",ifelse(region == "j.England","England","NW")),level3pc = as.numeric(l3_by19_rate)) %>%
  select(year = cohort_19_in,area,level3pc) %>%
  spread(key = area,value = level3pc)

m <- list(
  l = 150,
  r = 50,
  b = 50,
  t = 90,
  pad = 4
)

p <- plot_ly(level3age19,x = ~year) %>%
  add_trace(y = ~BwD,line = list(color = "blue",width = 3),marker = list(size = 8, color = "Blue"),
            type = 'scatter', mode = 'lines+markers',
            hoverinfo = 'text',name = "Blackburn with Darwen",
            text = ~ paste("<b>BwD </b>",year,"<br />","Level 3: <b>",round(BwD,1),'%</b>',"")) %>%
  add_trace(y = ~NW,line = list(color = "red",width =2 ),marker = list(size = 6, color = "red"),
            type = 'scatter', mode = 'lines+markers',
            hoverinfo = 'text',name = "North West",
            text = ~ paste("<b>NW </b>",year,"<br />","Level 3: <b>",round(NW,1),'%</b>',"")) %>%
  add_trace(y = ~England,line = list(color = "green",width = 2),marker = list(size = 6, color = "green"),
            type = 'scatter', mode = 'lines+markers',
            hoverinfo = 'text',name = "England",
            text = ~ paste("<b>England </b>",year,"<br />","Level 3: <b>",round(England,1),'%</b>',"")) %>%
  layout(margin = m,title = "Percentage with Level 3 qualification at age 19", xaxis = list(title = "",dtick=1,tickfont = list(size = 15)), 
         yaxis = list(title = "", range = c(30,65),ticksuffix = "%",tickfont = list(size = 15)),
         legend = list(x = 0.5,y=0.1,font = list(size = 15)))
p
```

### Economic Activity
```{block2, type = 'newstuff'}
This section contains updated material 
&nbsp;
<div style="text-align: right;font-size:80%;"><em>[‘Sparkling’](https://thenounproject.com/term/sparkling/1200272) icon by Morten Halvorsen from [The Noun Project](https://thenounproject.com)</em></div>
```
```{r echo = FALSE, warning = FALSE, message = FALSE}
# Economic activity breakdown, upper-tier authorities plus NW and England
activitydata <- read.csv('http://www.nomisweb.co.uk/api/v01/dataset/NM_17_5.data.csv?geography=1816133706,1816133712,1816133707,1816133713,1816133714,1816133708,1816133715,1816133709,1816133710,1816133716,1816133711,1816133683,1816133687,1816133684,1816133688...1816133690,1816133685,1816133691,1816133686,1816133731...1816133735,1816133717,1816133718,1816133736...1816133739,1816133719...1816133721,1816133740...1816133743,1816133722,1816133723,1816133744,1816133724,1816133725,1816133745,1816133726,1816133746,1816133747,1816133727,1816133748,1816133728,1816133749,1816133729,1816133730,1816133634,1816133633,1816133640,1816133635,1816133636,1816133641,1816133642,1816133637,1816133638,1816133643,1816133639,1816133644,1816133750,1816133751,1816133762...1816133764,1816133752,1816133765,1816133753,1816133754,1816133766,1816133755...1816133758,1816133767,1816133759,1816133768,1816133760,1816133761,1816133769...1816133772,1816133780...1816133782,1816133773...1816133775,1816133783,1816133776...1816133779,1816133645,1816133646,1816133652,1816133653,1816133647,1816133648,1816133651,1816133649,1816133663,1816133662,1816133664,1816133654...1816133657,1816133665,1816133666,1816133658...1816133660,1816133650,1816133661,1816133667,1816133698...1816133700,1816133692,1816133701,1816133693,1816133702,1816133696,1816133694,1816133695,1816133703,1816133697,1816133704,1816133705,1816133674,1816133678,1816133679,1816133675,1816133668,1816133669,1816133680,1816133681,1816133670,1816133671,1816133673,1816133676,1816133677,1816133682,1816133672,2092957699,2013265922&date=latest&variable=18,45,84,111,1493...1499&measures=20599,21001,21002,21003&select=date_name,geography_name,geography_code,variable_name,measures_name,obs_value,obs_status_name')

mainemprates <- activitydata %>% filter(MEASURES_NAME == "Variable") %>% filter(VARIABLE_NAME == "Employment rate - aged 16-64") %>%
  filter(GEOGRAPHY_CODE != "E09000001" & GEOGRAPHY_CODE != "E06000053" &
           GEOGRAPHY_CODE != "E92000001" & GEOGRAPHY_CODE != "E12000002") %>% # not City, Scilly, England or NW
  mutate(emprank = rank(OBS_VALUE))
bwdemprate <- mainemprates %>% filter(GEOGRAPHY_CODE == "E06000008") %>% select(OBS_VALUE)
bwdemprate <- as.numeric(bwdemprate)
bwdemprank <- mainemprates %>% filter(GEOGRAPHY_CODE == "E06000008") %>% select(emprank)
bwdemprank <- as.numeric(bwdemprank)
bwdemprank <- toOrdinal(bwdemprank)
bwdemprank <- ifelse(bwdemprank == "1st","",bwdemprank) # Don't want to say '1st lowest'

mainactrates <- activitydata %>% filter(MEASURES_NAME == "Variable") %>% filter(VARIABLE_NAME == "Economic activity rate - aged 16-64") %>%
       filter(GEOGRAPHY_CODE != "E09000001" & GEOGRAPHY_CODE != "E06000053" &
              GEOGRAPHY_CODE != "E92000001" & GEOGRAPHY_CODE != "E12000002") %>% # not City, Scilly, England or NW
       mutate(actrank = rank(OBS_VALUE))
bwdactrate <- mainactrates %>% filter(GEOGRAPHY_CODE == "E06000008") %>% select(OBS_VALUE)
bwdactrate <- as.numeric(bwdactrate)
bwdactrank <- mainactrates %>% filter(GEOGRAPHY_CODE == "E06000008") %>% select(actrank)
bwdactrank <- as.numeric(bwdactrank)
bwdactrank <- toOrdinal(bwdactrank)
bwdactrank <- ifelse(bwdactrank == "1st","",bwdactrank) # Don't want to say '1st lowest'

yearending <- substr(subset(mainactrates,GEOGRAPHY_CODE == "E06000008",select=DATE_NAME)$DATE_NAME,10,17)

# Collating data for chart
chartactivity <- activitydata %>% filter(GEOGRAPHY_CODE %in% c("E06000008","E92000001","E12000002")) # BwD, England or NW

Employed <- chartactivity %>% filter(VARIABLE_NAME == "Employment rate - aged 16-64") %>% 
     filter(MEASURES_NAME == "Variable") %>% mutate(VARIABLE_NAME = "Employed") %>% select(-MEASURES_NAME,-OBS_STATUS_NAME)

Active <- chartactivity %>% filter(VARIABLE_NAME == "Economic activity rate - aged 16-64") %>% 
  filter(MEASURES_NAME == "Variable") %>% mutate(VARIABLE_NAME = "Active") %>% select(-MEASURES_NAME,-OBS_STATUS_NAME)

Inactive <- chartactivity %>% filter(VARIABLE_NAME == "Economic activity rate - aged 16-64") %>% 
  filter(MEASURES_NAME == "Variable") %>% mutate(VARIABLE_NAME = "Inactive",inactive = 100 - OBS_VALUE) %>% 
  select(-MEASURES_NAME,-OBS_STATUS_NAME, -OBS_VALUE) %>% rename(OBS_VALUE = inactive)

Student <- chartactivity %>% filter(VARIABLE_NAME == "% of economically inactive student") %>% 
  filter(MEASURES_NAME == "Variable") %>% mutate(VARIABLE_NAME = "Student") %>% select(-MEASURES_NAME,-OBS_STATUS_NAME)

Looking_after_home <- chartactivity %>% filter(VARIABLE_NAME == "% of economically inactive looking after family/home") %>% 
  filter(MEASURES_NAME == "Variable") %>% mutate(VARIABLE_NAME = "Looking_after_home") %>% select(-MEASURES_NAME,-OBS_STATUS_NAME)

Long_term_sick <- chartactivity %>% filter(VARIABLE_NAME == "% of economically inactive long-term sick") %>% 
  filter(MEASURES_NAME == "Variable") %>% mutate(VARIABLE_NAME = "Long_term_sick") %>% select(-MEASURES_NAME,-OBS_STATUS_NAME)

UnempRate <- chartactivity %>% filter(VARIABLE_NAME == "Unemployment rate - aged 16-64 ") %>%
  filter(MEASURES_NAME == "Variable") %>% mutate(VARIABLE_NAME = "UnempRate") %>% select(-MEASURES_NAME,-OBS_STATUS_NAME)

reasons <- bind_rows(Employed,Student,Looking_after_home,Long_term_sick,Active,Inactive, UnempRate) %>%
  spread(VARIABLE_NAME,OBS_VALUE) %>%
  mutate(Unemployed = Active - Employed) %>%
  mutate(Other = 100 - Student - Looking_after_home - Long_term_sick) %>%
  mutate(Studentpc = Student*Inactive/100, Looking_after_homepc = Looking_after_home*Inactive/100,Long_term_sickpc = Long_term_sick*Inactive/100,
         Otherpc = Other*Inactive/100) %>%
  select(GEOGRAPHY_NAME,Active,Employed,Unemployed,Inactive,Long_term_sick = Long_term_sickpc, Looking_after_home = Looking_after_homepc, Student = Studentpc,
         Other = Otherpc, UnempRate)
reasons[4,] <- NA # Insert empty row to create more space at top of ggplot2 chart

tidyreasons <- gather(reasons, key = 'subcat',value = 'pc',-GEOGRAPHY_NAME)
tidyreasons$GEOGRAPHY_NAME <- factor(tidyreasons$GEOGRAPHY_NAME,levels = c("England","North West","Blackburn with Darwen"))
tidyreasons  <- tidyreasons %>% mutate(GEOGRAPHY_NAME = fct_recode(GEOGRAPHY_NAME,
                                                                   "BwD" = "Blackburn with Darwen",
                                                                   "NW" = "North West"))
levels(tidyreasons$GEOGRAPHY_NAME) <- c(levels(tidyreasons$GEOGRAPHY_NAME),"")
tidyreasons$GEOGRAPHY_NAME[is.na(tidyreasons$GEOGRAPHY_NAME)] <- ""

tidyreasons$subcat <- factor(tidyreasons$subcat, levels = c("Employed","Unemployed",
                                  "Long_term_sick","Looking_after_home","Student","Other","Active","Inactive","UnempRate"))
tidyreasons <- tidyreasons %>% mutate(subcat = fct_recode(subcat,
                              "Long-term sick"    = "Long_term_sick",
                              "Looking after home"      = "Looking_after_home"
  ))
```
As seen in Figure \@ref(fig:activitychart), an estimated `r bwdemprate`% of the borough’s residents aged 16-64 are employed _[@Nomis]_. This is the `r bwdemprank` lowest rate out of 150 upper tier local authorities (not including the City of London and Scilly Isles).

Together with those who are officially unemployed (i.e. actively seeking work and available to start), it means that only `r bwdactrate`% are ‘economically active’, which is the `r bwdactrank` lowest rate in England (again not including the City of London or Scilly Isles). 

(ref:activitycap) _(interactive)_ Economic activity & employment rate<br/>(age 16-64, year ending `r yearending`) _[@Nomis]_

```{r activitychart, fig.cap='(ref:activitycap)', echo=FALSE,message = FALSE, out.width='100%', fig.align='center'}
# knitr::include_graphics("Assets/p7fig15.png")
# plotly chart
truereasons <- reasons %>% filter(!is.na(GEOGRAPHY_NAME))
truereasons$GEOGRAPHY_NAME <- factor(truereasons$GEOGRAPHY_NAME,levels = c("England","North West","Blackburn with Darwen"))
levels(truereasons$GEOGRAPHY_NAME)[levels(truereasons$GEOGRAPHY_NAME)=="Blackburn with Darwen"] <- "Blackburn<br>with Darwen"
truereasons$EmpHover <- paste0("Employed: ",sprintf(truereasons$Employed, fmt = "%#.1f"),"%")
truereasons$UnempHover <- paste0("Unemployed: ",sprintf(truereasons$Unemployed, fmt = "%#.1f"),"%\n",
          "<i>(i.e. Unemployment Rate = \n", sprintf(truereasons$UnempRate, fmt = "%#.1f"),"% of Economically Active)</i>")
truereasons$SickHover <- paste0("Long-term sick: ",sprintf(truereasons$Long_term_sick, fmt = "%#.1f"),"%")
truereasons$HouseHover <- paste0("Looking after home: ",sprintf(truereasons$Looking_after_home, fmt = "%#.1f"),"%")
truereasons$StudHover <- paste0("Student: ",sprintf(truereasons$Student, fmt = "%#.1f"),"%")
truereasons$OthHover <- paste0("Other: ",sprintf(truereasons$Other, fmt = "%#.1f"),"%")
truereasons$ActiveAnno <- paste0("<b>Active: ",sprintf(truereasons$Active, fmt = "%#.1f"), "%</b>")
truereasons$EmpAnno <- paste0("<b>&nbsp;<br>",truereasons$EmpHover,"</b>")
truereasons$UnempAnno <- paste0("<b>&nbsp;",sprintf(" %#.1f%%",truereasons$Unemployed),"</b>")
truereasons$SickAnno <- paste0("<b>&nbsp;",sprintf(" %#.1f%%",truereasons$Long_term_sick),"</b>")
truereasons$HouseAnno <- paste0("<b>&nbsp;",sprintf(" %#.1f%%",truereasons$Looking_after_home),"</b>")
truereasons$StudAnno <- paste0("<b>&nbsp;",sprintf(" %#.1f%%",truereasons$Student),"</b>")
truereasons$OtherAnno <- paste0("<b>&nbsp;",sprintf(" %#.1f%%",truereasons$Other),"</b>")

m <- list(l = 100,
               r = 50,
               b = 60,
               t = 60,
               pad = 4)

p <- plot_ly(truereasons, y = ~GEOGRAPHY_NAME ) %>%
  add_trace(x = ~Employed, type = "bar", 
               marker = list(color = "rgb(255,102,255)"), name = 'Active - Employed', 
               legendgroup = 'group1',orientation = 'h',text = ~EmpHover,hoverinfo = "text") %>%
  add_trace(x = ~Unemployed,type = "bar",name = "Active - Unemployed", text = ~UnempHover,hoverinfo = "text",
            legendgroup = 'group1',marker = list(color = "rgb(255,187,255)")) %>%
  add_trace(x = ~Long_term_sick,type = "bar",name = "Inactive - Long-term sick",text = ~SickHover,hoverinfo = "text",
            legendgroup = 'group2',marker = list(color = "rgb(39,64,139)")) %>%
  add_trace(x = ~Looking_after_home,type = "bar",name = "Inactive - Looking after home",text = ~HouseHover,hoverinfo = "text",
            legendgroup = 'group2',marker = list(color = "rgb(67,110,238)")) %>%
  add_trace(x = ~Student,type = "bar",name = "Inactive - Student", text = ~StudHover,hoverinfo = "text",
            legendgroup = 'group2',marker = list(color = "rgb(92,172,238)")) %>%
  add_trace(x = ~Other,type = "bar",name = "Inactive - Other", text = ~OthHover,hoverinfo = "text",
            legendgroup = 'group2',marker = list(color = "rgb(176,224,230)")) %>%
  
  # Horizontal line to give width to arrows
  add_segments(x = ~Active - 1,y = ~GEOGRAPHY_NAME,xend = 1,yend = ~GEOGRAPHY_NAME, color = I('black'),
               line = list(width = 4),showlegend = FALSE, hoverinfo = "none") %>% # leave 1 pc space at either end 
                                                              # to avoid showing through behind arrow
  # Arrows pointing right and left
  add_annotations(x = ~Active,y = ~GEOGRAPHY_NAME,ax = 0,ay = 0, xref = "x",yref = "y",axref = "x",
                  text = "", size = 3, color = I('black'),showarrow = TRUE, arrowhead = 3, arrowsize = 1.5) %>%
  add_annotations(x = 0,y = ~GEOGRAPHY_NAME,ax = ~Active,ay = 0, xref = "x",yref = "y",axref = "x",
                  text = "", size = 3, color = I('black'),showarrow = TRUE, arrowhead = 3, arrowsize = 1.5) %>%
  
  # Text above arrows
  add_annotations(x = ~Active/2, y = ~GEOGRAPHY_NAME, xref = "x",yref = "y",text = ~ActiveAnno, xanchor = "center",
                  yanchor = "bottom",showarrow = FALSE, font=list(size = 16, face = 'bold')) %>%
  
  # Text below arrows
  add_annotations(x = ~Employed/2,y = ~GEOGRAPHY_NAME,xref = "x",yref = "y", text = ~EmpHover, xanchor = "center",
                  yanchor = "top",ypad = 10, showarrow = FALSE, font = list(size = 16,color = "white")) %>%
  
  layout(margin = m,xaxis = list(title = "",ticksuffix = "%",tickfont = list(size = 16), zeroline=FALSE),
         yaxis = list(title = "",tickfont = list(size = 18)),barmode = 'stack',
         legend = list(orientation = 'h',xanchor = "center",
                       x = 0.5,font = list(size = 14),traceorder = "grouped"))
  
p
```

### Looking for Work
#### Unemployment
```{r echo = FALSE, warning = FALSE, message = FALSE}
unemp <- read.csv("http://www.nomisweb.co.uk/api/v01/dataset/NM_17_5.data.csv?geography=1816133645,2092957699,2013265922&date=latestMINUS56,latestMINUS52,latestMINUS48,latestMINUS44,latestMINUS40,latestMINUS36,latestMINUS32,latestMINUS28,latestMINUS24,latestMINUS20,latestMINUS16,latestMINUS12,latestMINUS8,latestMINUS4,latest&variable=84&measures=20599,21001,21002,21003&select=date_name,geography_name,geography_code,variable_name,measures_name,obs_value")
monthend <- substr(as.character(first(unemp$DATE_NAME)),10,12) # i.e. data is for 12 months to this month each year
unemp <- unemp %>% mutate(year = as.numeric(substr(DATE_NAME,14,17)))
BwDcount <- unemp %>% filter(GEOGRAPHY_NAME == "Blackburn with Darwen" & MEASURES_NAME == "Numerator" & year == max(year)) %>% select(OBS_VALUE) %>% pull()
BwDrate <- unemp %>% filter(GEOGRAPHY_NAME == "Blackburn with Darwen" & MEASURES_NAME == "Variable" & year == max(year)) %>% select(OBS_VALUE) %>% pull()
latestyear <- unemp %>% filter(year == max(year)) %>% distinct(year)
BwDconf <- unemp %>% filter(MEASURES_NAME == "Confidence" & GEOGRAPHY_NAME == "Blackburn with Darwen") # only want CIs for BwD, not NW or England

unemp <- unemp %>% filter(MEASURES_NAME == "Variable") %>% select(GEOGRAPHY_NAME,OBS_VALUE,year) %>% spread(key = GEOGRAPHY_NAME, value = OBS_VALUE) %>%
  left_join(BwDconf, by=c('year'='year')) %>% select(year,BwD = `Blackburn with Darwen`,England,NW = `North West`,BwDconf = OBS_VALUE)
```
Strictly speaking, unemployment is defined by whether people are actively seeking work and available to start, rather than by any benefits they may be claiming. This can only be ascertained from a sample survey, so the estimates for an area such as Blackburn with Darwen are subject to large confidence intervals (Figure \@ref(fig:unempchart)). The latest results (for the twelve months to `r monthend` `r latestyear`) suggest that there are approximately `r BwDcount` unemployed people of working age in Blackburn with Darwen. It is conventional to express this as a percentage of the economically active population, which gives a rate of `r BwDrate`%.

(ref:unempcap) _(interactive)_ Unemployment rate (age 16-64),<br/>Blackburn with Darwen, North West and England<br/><em>(showing 95% confidence intervals for BwD)[@Nomis]</em>

```{r unempchart, fig.cap='(ref:unempcap)', echo=FALSE,warning = FALSE, message = FALSE, out.width='100%', fig.align='center'}
#knitr::include_graphics("Assets/p8fig16.png")
m <- list(
  l = 100,
  r = 180,
  b = 50,
  t = 90,
  pad = 4
)

p <- plot_ly(unemp,x = ~year) %>%
  add_trace(y = ~BwD,line = list(color = "blue",width = 3),marker = list(size = 8, color = "Blue"),
                      type = 'scatter', mode = 'lines+markers',
                      hoverinfo = 'text',name = "Blackburn with Darwen",
                      text = ~ paste("<b>BwD </b>, year to ",monthend," <b>",year,"</b><br />","Unemployment rate: <b>",round(BwD,1),'%</b>',""),
                      error_y = list(array = ~BwDconf,type = "bar", color = "blue", thickness = 1, opacity = 0.5)) %>%
  add_trace(y = ~NW,line = list(color = "red",width = 2),marker = list(size = 6, color = "red"),
            type = 'scatter', mode = 'lines+markers',
            hoverinfo = 'text',name = "North West",
            text = ~ paste("<b>NW </b>, year to ",monthend," <b>",year,"</b><br />","Unemployment rate: <b>",round(NW,1),'%</b>',"")) %>%
  add_trace(y = ~England,line = list(color = "green",width = 2),marker = list(size = 6, color = "green"),
            type = 'scatter', mode = 'lines+markers',
            hoverinfo = 'text',name = "England",
            text = ~ paste("<b>England </b>, year to ",monthend," <b>",year,"</b><br />","Unemployment rate: <b>",round(England,1),'%</b>',"")) %>%
  layout(margin = m,title = "", xaxis = list(title = "",dtick=1,tickfont = list(size = 15)), 
         yaxis = list(rangemode = 'tozero',title = "", ticksuffix = "%",tickfont = list(size = 15)),
         legend = list(x = 0.1,y=0.1,font = list(size = 15)))
p          
```

#### Claimant Count
```{block2, type = 'newstuff'}
This section contains updated material 
&nbsp;
<div style="text-align: right;font-size:80%;"><em>[‘Sparkling’](https://thenounproject.com/term/sparkling/1200272) icon by Morten Halvorsen from [The Noun Project](https://thenounproject.com)</em></div>
```
It is obvious from Figure \@ref(fig:unempchart) that it would be useful to have a proxy for the official unemployment count, which does not depend on a survey. For many years, that need was met by the Claimant Count. Since the introduction of Universal Credit, however, things have not been quite so simple.

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.align='center'}
# Want all dates from April 2015 (= 32244) to latest. Found out that April 2015 was '32244' by doing https://www.nomisweb.co.uk/api/v01/dataset/nm_1_1.overview.xml
nomisurl <- 'http://www.nomisweb.co.uk/api/v01/dataset/NM_162_1.data.csv?geography=1870659597,2092957699,2013265922&date=32244-latest&gender=0&age=0&measure=1,2&measures=20100&select=date_name,date_sortorder,geography_name,measure_name,obs_value'

nomisdata <- read.csv(file=nomisurl, header=TRUE,sep = ",")

# put DATE_NAME in chronological order
nomisdata$DATE_NAME <- factor(nomisdata$DATE_NAME,levels=unique(nomisdata$DATE_NAME[order(nomisdata$DATE_SORTORDER)]),ordered=TRUE)

# substitute snappier measure names
nomisdata$MEASURE_NAME <- as.character(nomisdata$MEASURE_NAME)
nomisdata <- within(nomisdata,{
  MEASURE_NAME[MEASURE_NAME == "Claimants as a proportion of residents aged 16-64"] <- "rate"
  MEASURE_NAME[MEASURE_NAME == "Claimant count"] <- "count"
})

nomisdata <- nomisdata %>% spread(key = MEASURE_NAME,value = OBS_VALUE) # Now has 'count' and 'rate' as separate columns

bwdLatest <- nomisdata[which(nomisdata$DATE_SORTORDER == max(nomisdata$DATE_SORTORDER) & nomisdata$GEOGRAPHY_NAME == "Blackburn with Darwen"),]
bwdLatestCount <- bwdLatest$count
bwdLatestRate <- bwdLatest$rate
latestDate <- bwdLatest$DATE_NAME
nomisdata$geogAbb <- ifelse(nomisdata$GEOGRAPHY_NAME == 'Blackburn with Darwen','BwD',as.character(nomisdata$GEOGRAPHY_NAME))
```
The Claimant Count now consists of the (diminishing) number of people still on Job Seekers Allowance, plus those claiming Universal Credit _who are required to seek work_ _[@HCL_unemp]_.  It is available on this basis going back to April 2015 (Figure \@ref(fig:claimcountchart)). The latest Claimant Count total for the borough (in `r latestDate`) was `r bwdLatestCount`. As a percentage of the working-age population (not just the economically active), this gives a rate of `r bwdLatestRate`%.

(ref:claimcountcap) _(interactive)_ Claimant Count as a % of residents aged 16-64 _[@Nomis]_

```{r claimcountchart, fig.cap='(ref:claimcountcap)', echo = FALSE, warning = FALSE, message = FALSE, fig.align='center',out.width='100%'}
#knitr::include_graphics("Assets/p8fig17.png")

pal <- c("red","blue","green")
pal <- setNames(pal,c("North West","BwD","England"))

xx <- list(
  title = ""
)
yx <- list(
  title = "",
  ticksuffix = "%"
)

m <- list(
  l = 40,
  r = 170, # make this large so tooltips show on right
  b = 120,
  t = 60,
  pad = 4
)

p <- nomisdata %>%
  group_by(geogAbb) %>%
  plot_ly(x = ~DATE_NAME,y = ~rate,color = ~ geogAbb) %>%
  add_lines(text = ~ paste(DATE_NAME,"<br />",
                          "Rate: <b>",rate,'%</b>',
                          ifelse(geogAbb == "BwD",paste0("<br /><em>(",count," people)</b>"),"")),
            colors = pal,
            hoverinfo = "text+name") %>%
  layout(xaxis = xx, yaxis = yx, margin = m,
         legend = list(x = 0.1, y = 0.9)
         )

p
```

##### Impact of Universal Credit 'Full Service'
However, **Figure \@ref(fig:claimcountchart) must be interpreted with caution**. As Universal Credit is rolled out, the rules about who is required to seek work in order to receive benefit keep changing. This makes it difficult to interpret trends in the Claimant Count, and has led ONS to demote it to an ‘Experimental Statistic’.

Judging by Figure \@ref(fig:claimcountchart), it might be thought that the Blackburn with Darwen economy has taken a turn for the worse since February 2018. However, that is not necessarily the case, because in February 2018, the borough became a **‘Full Service’** area for Universal Credit.^[‘Full Service’ means that Universal Credit is available to all types of new claimants, rather than being restricted (as before) to those whose claims are relatively simple.]  More people are required to seek work under Universal Credit than under the legacy benefits that it replaces, so the recent sharp rise in the Claimant Count may well reflect the fact that the ‘goalposts’ have moved. A similar sharp rise was seen in areas which moved to Full Service last year (2017) _[@HCL_unemp]_.

##### Claimant Count Across the Borough
```{r echo = FALSE, warning = FALSE, message = FALSE,results = 'hide'}
claimants <- read.csv("http://www.nomisweb.co.uk/api/v01/dataset/NM_162_1.data.csv?geography=1245710832...1245710849&date=latest&gender=0&age=0&measure=1&measures=20100&select=date_name,geography_name,geography_code,gender_name,age_name,measure_name,obs_value")
pop <- read.csv("http://www.nomisweb.co.uk/api/v01/dataset/NM_2010_1.data.csv?geography=1245710832...1245710849&date=latest&gender=0&c_age=203&measures=20100&select=date_name,geography_name,geography_code,gender_name,c_age_name,obs_value")

popyear <- pop %>% distinct(DATE_NAME)
claimmonth <- claimants %>% distinct(DATE_NAME)
  
MSOAs <- st_read("F:/R Programming/Misc work/MSOA DFLE and HLE/MSOA Blackburn_region.shp")

claimants <- select(claimants,GEOGRAPHY_CODE,claimants = OBS_VALUE)
pop <- select(pop,GEOGRAPHY_CODE,pop = OBS_VALUE)

MSOAs <- MSOAs %>% left_join(claimants, by = c("MSOA_CODE"="GEOGRAPHY_CODE"))
MSOAs <- MSOAs %>% left_join(pop,by = c("MSOA_CODE"="GEOGRAPHY_CODE"))
MSOAs <- MSOAs %>% mutate(rate = claimants/pop*100)
```
The fact that it is difficult to interpret the _trend_ in the Claimant Count does not prevent us from looking at how it varies _across Blackburn with Darwen_ at a snapshot in time. Figure \@ref(fig:claimmap) shows how the rate as at `r claimmonth` ranged from `r round(min(MSOAs$rate))`% to `r round(max(MSOAs$rate))`% across the Borough's 18 Middle Super Output Areas (MSOAs).

(ref:claimmapcap) _(interactive)_ Claimant Count rates at MSOA level, `r claimmonth`,<br/>as a % of residents aged 16-64<br/><em>(using mid-`r popyear` population estimates) [@Nomis]</em>

```{r claimmap, fig.cap='(ref:claimmapcap)', echo=FALSE,message = FALSE, warning = FALSE,out.width='100%', fig.align='center'}
#knitr::include_graphics("Assets/p8fig18.png")
plot_ly(MSOAs,split = ~MSOA_CODE,
        line = list(width = 1, color = "lightgray"),
        color = ~rate,colors = "PuRd",alpha = 1,
        hoveron = "fills",hoverinfo="text",type = "scatter",mode = "lines",
        text = ~paste("MSOA: ",MSOA_CODE,"\nClaimant count: <b>",claimants,"</b>\nClaimant count rate: <b>",round(rate,1),"%</b>")) %>%
        colorbar(title= "Claimant\nCount\nRate",tickfont = list(size = 18),titlefont = list(size = 20),ticksuffix = "%",
                 lenmode = "fraction",len = 0.8)%>%
hide_legend() 
```

### Employment by Sector
Both locally and nationally, the biggest sector for employment is Health (Figure \@ref(fig:sectorchart)). Health, Education and Public Admininstration together account for just over a third of Blackburn with Darwen employees, compared with a national average of just over a quarter. 16.4% of employees in Blackburn with Darwen work in Manufacturing, which is more than twice the England average of 8.1%.

(ref:sectorcap) Employees by sector - <br/>Blackburn with Darwen compared with England (2017)<br/><em>Source: BRES data from Nomis [@Nomis]</em>

```{r sectorchart, fig.cap='(ref:sectorcap)', echo=FALSE,out.width='60%', fig.align='center'}
knitr::include_graphics("Assets/p9fig19.png")
```

### Productivity
Productivity describes the ability to produce outputs from a given amount of inputs such as labour. Economic output can only be increased by raising the amount of inputs (e.g. employees) or by raising their productivity, so productivity is vital to improving standards of living _[@ONS_productivity]_.  

The preferred sub-regional measure of productivity is Gross Value Added (GVA) per hour worked. On this basis, Blackburn with Darwen has the 12th lowest productivity out of 168 ‘NUTS 3’ areas in the UK (Figure \@ref(fig:GVAchart)), at 77.6% of the UK average _[@ONS_productivity]_.

(ref:GVAcap) Productivity (GVA per hour worked) -<br/>20 lowest ranking NUTS3 areas, relative to UK (2016)

```{r GVAchart, fig.cap='(ref:GVAcap)', echo=FALSE,out.width='60%', fig.align='center'}
knitr::include_graphics("Assets/p9fig20.png")
```

### Earnings
```{block2, type = 'newstuff'}
This section contains updated material 
&nbsp;
<div style="text-align: right;font-size:80%;"><em>[‘Sparkling’](https://thenounproject.com/term/sparkling/1200272) icon by Morten Halvorsen from [The Noun Project](https://thenounproject.com)</em></div>
```
```{r echo = FALSE, warning = FALSE, message = FALSE}
earnings <- read.csv('http://www.nomisweb.co.uk/api/v01/dataset/NM_30_1.data.csv?geography=1941962826,1941962832,1941962827,1941962833,1941962834,1941962828,1941962835,1941962829,1941962830,1941962836,1941962831,1941962803,1941962807,1941962804,1941962808...1941962810,1941962805,1941962811,1941962806,1941962851...1941962855,1941962837,1941962838,1941962856...1941962859,1941962839...1941962841,1941962860...1941962863,1941962842,1941962843,1941962864,1941962844,1941962845,1941962865,1941962846,1941962866,1941962867,1941962847,1941962868,1941962848,1941962869,1941962849,1941962850,1941962754,1941962753,1941962760,1941962755,1941962756,1941962761,1941962762,1941962757,1941962758,1941962763,1941962759,1941962764...1941962766,1941962772,1941962773,1941962767,1941962768,1941962771,1941962769,1941962783,1941962782,1941962784,1941962774...1941962777,1941962785,1941962786,1941962778...1941962780,1941962770,1941962781,1941962787,1941962870,1941962871,1941962882...1941962884,1941962872,1941962885,1941962873,1941962874,1941962886,1941962875...1941962878,1941962887,1941962879,1941962888,1941962880,1941962881,1941962889...1941962892,1941962901...1941962903,1941962893...1941962896,1941962904,1941962897...1941962900,1941962818...1941962820,1941962812,1941962821,1941962813,1941962822,1941962816,1941962814,1941962815,1941962823,1941962817,1941962824,1941962825,1941962794,1941962798,1941962799,1941962795,1941962788,1941962789,1941962800,1941962801,1941962790,1941962791,1941962793,1941962796,1941962797,1941962802,1941962792,2092957699,2013265922&date=latest&sex=7&item=2&pay=1&measures=20100,20701&select=date_name,geography_name,geography_code,sex_name,pay_name,item_name,measures_name,obs_value,obs_status_name')

bwdearnings <- earnings %>% filter(GEOGRAPHY_CODE == "E06000008" & MEASURES_NAME == "Value") %>% select(OBS_VALUE)
Englandearnings <- earnings %>% filter(GEOGRAPHY_CODE == "E92000001" & MEASURES_NAME == "Value") %>% select(OBS_VALUE)
NWearnings <- earnings %>% filter(GEOGRAPHY_CODE == "E12000002" & MEASURES_NAME == "Value") %>% select(OBS_VALUE)

bwdearnings <- as.numeric(bwdearnings)
Englandearnings <- as.numeric(Englandearnings)
NWearnings <- as.numeric(NWearnings)

thisyear <- first(earnings$DATE_NAME)

mainearnings <- earnings %>% filter(MEASURES_NAME == "Value") %>%
  filter(GEOGRAPHY_CODE != "E92000001" & GEOGRAPHY_CODE != "E12000002") %>% # eliminate England and Nw
  filter(!is.na(OBS_VALUE)) %>% # effectively eliminates Scilly
  mutate(earnrank = rank(OBS_VALUE)) %>%
  arrange(earnrank) %>%
  select(GEOGRAPHY_NAME,GEOGRAPHY_CODE,earnings = OBS_VALUE,earnrank) %>%
  mutate(BwD = ifelse(GEOGRAPHY_NAME == "Blackburn with Darwen",1,0)) %>%
  mutate(Englandearnings = Englandearnings) %>%
  mutate(NWearnings = NWearnings)

mainearnings$GEOGRAPHY_NAME <- factor(mainearnings$GEOGRAPHY_NAME) #drop unused levels
mainearnings$GEOGRAPHY_NAME <- reorder(x = mainearnings$GEOGRAPHY_NAME,X = mainearnings$earnings,FUN = sum)
mainearnings$GEOGRAPHY_CODE <- factor(mainearnings$GEOGRAPHY_CODE) #drop unused levels
mainearnings$BwD <- factor(mainearnings$BwD)
mainearnings$my_hover <- paste0(mainearnings$GEOGRAPHY_NAME,": ",sprintf("£%.2f", mainearnings$earnings),sep="")

bwdearnrank <- mainearnings %>% filter(GEOGRAPHY_CODE == "E06000008") %>% select(earnrank)
bwdearnrankfloor <- floor(bwdearnrank)
bwdearnrankjoint <- ifelse(bwdearnrank == bwdearnrankfloor,"","joint ") # e.g. if rank is '8.5', that means a tie
bwdrank <- paste0(bwdearnrankjoint,toOrdinal(bwdearnrankfloor),"")
bwdrank <- ifelse(bwdrank == "1st","",bwdrank) # Don't want to say '1st lowest'
numLAs <- nrow(mainearnings)
```
Provisional median gross weekly earnings for Blackburn with Darwen residents in `r thisyear` were £`r bwdearnings`. This puts Blackburn with Darwen `r bwdrank` lowest out of `r numLAs` upper-tier authorities in England (Figure \@ref(fig:earnchart)) _[@Nomis]_.

(ref:earncap) _(interactive)_ Provisional Median Gross Weekly Earnings of residents -<br/><span style='color:blue'>Blackburn with Darwen</span> v. other Upper-Tier Authorities in England (`r thisyear`) <em>[@Nomis]</em>

```{r earnchart, fig.cap='(ref:earncap)', echo=FALSE,out.width='100%', fig.align='center'}
# knitr::include_graphics("Assets/p9fig21.png")
# Plotly chart
m <- list(
  l = 50,
  r = 50,
  b = 30,
  t = 10,
  pad = 4
)

p <- plot_ly(mainearnings,x = ~GEOGRAPHY_NAME,y = ~earnings,
        type = "bar", text = ~my_hover, hoverinfo = "text",
        color = ~BwD, colors = c("Lightblue","Blue")) %>%
  
    add_trace(y = ~Englandearnings, type = "scatter", mode = "lines", line = list(color = "Green")) %>%
    add_trace(y = ~NWearnings,type = "scatter", mode = "lines",line = list(color = "Red")) %>%
    
    add_annotations(xref = "paper",yref = "y",x = 1,y = Englandearnings,xanchor = "right",yanchor = "bottom",
                    text = paste0("England: ",sprintf("<b>£%.2f</b>", Englandearnings),sep=""),
                    showarrow = F, font = list(color = "Green", size = 14)) %>%
    add_annotations(xref = "paper",yref = "y",x = 1,y = NWearnings,xanchor = "right",yanchor = "top",
                    text = paste0("North West: ",sprintf("<b>£%.2f</b>", NWearnings),sep=""),
                    showarrow = F, font = list(color = "Red", size = 14)) %>%
  
    layout(margin = m, showlegend = FALSE,bargap = 0, 
    xaxis = list(title = "", showspikes = TRUE, showticklabels = FALSE,
      tickfont = list(color = "White")), # Don't want to see x-axis labels but still want showspikes to work
    yaxis = list(title = "", tickprefix = "£", hoverformat = '.2f')) 
p
```

### Household Income
#### Gross Disposable Household Income
Gross Disposable Household Income (GDHI) is the amount of money that individuals in households have available for spending after taxes and benefits. Provisional estimates for 2017 are now available by local authority _[@ONS_grossdisp]_.  

The Blackburn with Darwen average of £12,623 per head is the 3rd lowest in the UK (after Nottingham and Leicester), and the lowest in the North West. It compares with an England average of £19,988. Blackburn with Darwen has consistently been in 2nd or 3rd lowest place for the past seven years.

(ref:dispinccap) Gross Disposable Household Income per head (2017, provisional): <br/><span style='color:red'>lowest</span> and <span style='color:blue'>highest</span> local authority per region

```{r dispincchart, fig.cap='(ref:dispinccap)', echo=FALSE,out.width='90%', fig.align='center'}
knitr::include_graphics("Assets/p10fig22.png")
```

#### Total Household Income
ONS also issues various modelled estimates of household income at the smaller Middle Super Output Area (MSOA) level _[@ONS_smallinc]_. Figure \@ref(fig:hhldincchart) shows a map of how Total Annual Household Income (before tax) varies across the borough.

Half of Blackburn with Darwen’s 18 MSOAs are in the bottom national decile for household income (darkest purple), with estimated average incomes ranging from £20,100 to £29,100. Eight of them form a broad swathe across Blackburn. The lowest of all is in Audley, and this MSOA ranks third lowest in England (out of 6791). The next lowest MSOA in Blackburn with Darwen, covering the town centre area, ranks 11th lowest in England. By contrast, Blackburn with Darwen also has one MSOA in the second-highest national decile (dark green), with an estimated average of £51,500.

It is stressed that these are only estimates, with a wide degree of uncertainty around them.

(ref:hhldinccap) Estimated Total Annual Household Income (MSOAs, 2015/16)<br/><em>NB- measured per household, not per head</em>

```{r hhldincchart, fig.cap='(ref:hhldinccap)', echo=FALSE,out.width='60%', fig.align='center'}
knitr::include_graphics("Assets/p10fig23.png")
```

## Safe and Healthy Homes\
and Neighbourhoods
### Housing
```{block2, type = 'newstuff'}
This section contains updated material 
&nbsp;
<div style="text-align: right;font-size:80%;"><em>[‘Sparkling’](https://thenounproject.com/term/sparkling/1200272) icon by Morten Halvorsen from [The Noun Project](https://thenounproject.com)</em></div>
```

#### Private Rented Sector
>“The private-rented sector in the UK is growing and has worse housing conditions than any other sector.”
>
> --- Parliamentary Office of Science & Technology _[POST]_

##### Housing Conditions
Evidence from the English Housing Survey shows that the private rented sector nationally has the highest rate of serious (‘Category 1’) hazards, the highest proportion of houses with poor energy efficiency ratings, and the highest prevalence of damp (Figure \@ref(fig:housecondchart)) _[@DEBATE2019]_. Private rented housing was also the most likely to be old, to be non-decent (a broader classification, including problems of disrepair and ageing facilities), and to be suffering from damp _[@POST2018; @MHCLG2018]_.

(ref:housecondcap) National findings from the English Housing Survey (2017) <em>[@DEBATE2019]</em><br/><em>('EPC' = 'Energy Performance Certificate')</em>

```{r housecondchart, fig.cap='(ref:housecondcap)', echo=FALSE,out.width='60%', fig.align='center'}
knitr::include_graphics("Assets/p11fig24.png")
```

##### Local Market
Modelled estimates (which ONS stress are _not_ official statistics) suggest that Blackburn with Darwen had approximately 8875 privately rented houses in 2017 _[@ONS_tenure]_.  Data from the Valuation Office Agency (VOA) shows that median private-sector rents in Blackburn with Darwen were the 16th lowest in England in 2018-19. The rental for a non-self-contained room was the lowest in the NW _[@VOA2019]_.

##### Regulation
‘Houses in Multiple Occupation’ (HMOs) often house some of the most vulnerable people. Since October 2018, mandatory licensing applies to any rented property occupied by 5+ unrelated people, sharing facilities such as a kitchen, toilet or bathroom (Figure \@ref(fig:hmomap)). 

Selective licensing schemes for private rented housing can be an effective tool for driving up standards and reversing neighbourhood decline in areas of low demand. Blackburn with Darwen has one such scheme in Darwen, and one in the Infirmary area of Blackburn (Figure \@ref(fig:hmomap)) _[@BwD_Infirmary; @BwD_Darwen]_.

```{r hmomap, fig.cap='Licensed HMOs & Selective Licensing Areas in BwD', echo = FALSE, out.width = '60%', fig.align='center'}
knitr::include_graphics("Assets/p11fig25.png")
```

##### Cold housing and Fuel Poverty
As well as being a major contributor to excess winter deaths, cold housing adds to the burden of circulatory and respiratory disease, colds and flu, exacerbates chronic conditions such as rheumatism and arthritis, and has a negative effect upon mental health _[@MRT2011]_.  

An estimated 9895 households in Blackburn with Darwen (16.5%) were classed as being in ‘fuel poverty’ in 2017, putting it 6th highest (England 10.9%, North West 13.1%). Figure \@ref(fig:fuelpovchart) shows how these estimates vary across the borough _[@DBEIS2019a; @DBEIS2019b]_. However, ONS is now suggesting a different estimation method, which would put Blackburn with Darwen on 15.2%, or 23rd in the country _[@ONS_newFP]_. This is ‘experimental’ at the moment, but may become official in future.

(ref:fuelpovcap) Households in Fuel Poverty, 2017 (modelled estimates)<br/><em>Lower Super Output Areas overlaid with wards, Source BEIS</em>

```{r fuelpovchart, fig.cap='(ref:fuelpovcap)', echo=FALSE,out.width='50%', fig.align='center'}
knitr::include_graphics("Assets/FP.png")
```

Blackburn with Darwen does its best to promote energy efficiency and available grants via initiatives such as its ‘Heat and Eat’ events _[@HeatEat]_, and marked Fuel Poverty Awareness Day by holding ‘Blackburn with Darwen’s Biggest Housewarming’ event (Figure \@ref(fig:housewarm)) _[@HouseWarm]_.

(ref:housewarmcap) Blackburn with Darwen's "Biggest Housewarming Event"<br /><em>(Fuel Poverty Awareness Day, 2019)</em>

```{r housewarm, fig.cap='(ref:housewarmcap)', echo = FALSE, out.width = '60%', fig.align='center'}
knitr::include_graphics("Assets/housewarm.png")
```

### Crime and Violence
#### Crime and Antisocial Behaviour
Data about the type and whereabouts of every recorded incident of crime or antisocial behaviour is available from http://data.police.uk/. In Figure \@ref(fig:crimemaps), the darkest pink shading denotes the areas with the greatest number of incidents in the year to December 2018.^[All recorded crime figures have to be treated with caution, as they do not currently meet the standards required for National Statistics status.]

(ref:crimecap) Locations of recorded Crime and Antisocial Behaviour (January - December 2018)<br/><em>Only includes crimes with a recorded type and location, and hexagons lying entirely within BwD</em>

```{r crimemaps, fig.cap='(ref:crimecap)', echo=FALSE,out.width='100%', fig.align='center'}
knitr::include_graphics("Assets/Crime_hex_maps_narrower.png")
```

#### Violent and Sexual Offences
The Public Health Outcomes Framework _[@PHE_PHOF]_ monitors the rate of violent crime and the rate of sexual offences. In 2017/18, both rates were higher than average in Blackburn with Darwen. They were also both rising, but this was the case in every NW district. Public Health England does not feel it is appropriate to rag-rate these indicators, as high or low levels could be due to high or low levels of recording. The borough also had the 18th highest rate nationally of hospital admissions for violence in 2015/16 – 2017/18.

### Fast Food Outlets
#### Number and density
![](Assets/p13headline.png)

##### 'CEDAR' Estimates
Blackburn with Darwen became briefly notorious as the ‘takeaway capital’ of England in July 2017, when research from the ‘CEDAR’ Unit at Cambridge University _[@Cambs2017]_ gave rise to newspaper headlines like the one above _[@Gdn_chips]_. Blackburn with Darwen’s 236 takeaways were not (quite) the highest number _per head_ (that honour went to Westminster). However, they did represent the highest number of takeaways _as a proportion of all food outlets in the borough_ (38%).

A subsequent Guardian article, also based on data from CEDAR, found that 400 schools in England had 20 or more fast food outlets within a 400m radius. St Anne’s School, in the centre of Blackburn, was said to be in the top ten, with 46 nearby outlets _[@Gdn_poor]_. 

##### PHE Estimates
Since then, Public Health England (PHE) has published its own analysis, using a different data source and definition.^[Public Health England is quite candid about the fact that the definition of a 'fast food outlet' is somewhat arbitrary.] The PHE data shows Blackburn with Darwen to have 219 ‘fast food outlets’ as at 31st December 2017 (Figure \@ref(fig:fastfoodmaps)) _[@PHE_fastfood]_.  This equates to 147.5 outlets per 100,000 population, which is the 13th highest density in the country. By comparison, the England average is 96.5, and the maximum (in Blackpool) is 232.2.

PHE’s density map shows a clear north-south divide (Figure \@ref(fig:fastfoodmaps)), and a strong link with deprivation. As well as Blackburn with Darwen, Burnley and Hyndburn also rank highly. PHE also provides ward-level counts, which let us see where the borough’s 219 fast food outlets are concentrated.

(ref:fastfoodcap) Fast Food Outlets per 100,000 population (right)<br/>and counts per pre-2018 ward (left)<br/>December 2017 <em>[@PHE_fastfood]</em>

```{r fastfoodmaps, fig.cap='(ref:fastfoodcap)', echo=FALSE,out.width='80%', fig.align='center'}
knitr::include_graphics("Assets/p13fig28.png")
```

#### Evidence and policy
Giving evidence to the recent House of Commons Childhood Obesity Inquiry, the CEDAR team at Cambridge University drew attention to the typical cheapness, high-calorie content and large portion size of takeaway food, and the concentration of fast food outlets in deprived areas. They concluded that takeaways were linked to obesity (and to inequalities in obesity) in a way that supermarkets and restaurants were not _[@Cedar2018]_.  Public Health England has also alluded to the ‘growing body of evidence’ connecting fast food outlets to obesity _[@PHE_fastfood]_.

Blackburn with Darwen’s ‘Eat Well Move More Shape Up’ strategy acknowledges how fast food outlets are over-represented in deprived areas, the temptation they pose to young people in particular, and the need for tighter controls to regulate their growth _[@BwD_EatWell]_.  Since April 2016, the borough has operated a policy of refusing permission for new takeaways within 400m of any primary or secondary school, madrassa, nursery or college, unless there are fewer than five such establishments already _and_ the proposed opening hours are outside those of the educational institution _[@BwD_PlanHealth]_. 

## Wellbeing and Social Mobility
### The Social Mobility Index
The Social Mobility Commission has updated its Social Mobility Index _[@SMC2017]_, designed to identify places where people from disadvantaged backgrounds are more or less likely to make social progress during their lives. The Index is based on educational attainment before, during and after the school years, and the outcomes achieved by adults in terms of income, job status and home ownership.

#### Overall Index
On the overall Social Mobility Index, Blackburn with Darwen sits almost exactly mid-table, ranking **161st** out of 324 English lower-tier local authorities (where 1st is best). The authors of the report detect a growing gap between social mobility ‘hotspots’ and ‘coldspots’, with London pulling further ahead of the rest of the country. Prospects for disadvantaged people tend to be worst in remote, coastal or rural areas, and formerly industrial districts.


```{r socmobmap, fig.cap='Social Mobility Index 2017 (overall ranking)', echo = FALSE, out.width = '80%', fig.align='center'}
knitr::include_graphics("Assets/p14fig29.png")
```

#### Life Stage Indices
The overall Social Mobility Index is made up of four life-stage Indices, each based on between 2 and 5 indicators. Figure \@ref(fig:socmobchart) gives an overview of Blackburn with Darwen’s relative performance on each indicator, and for each life-stage as a whole.

Blackburn with Darwen continues to rank as a ‘coldspot’ (well below average) for Early Years social mobility, coming 31st from bottom in the rankings. However it then leaps to 70th best place at School age, and 65th best for Youth. Unfortunately, the borough does not compare so favourably on the economic indicators used to assess Adult social mobility, and it slips back to 82nd from the bottom.

```{r socmobchart, fig.cap='Breakdown of Social Mobility Index for Blackburn with Darwen', echo = FALSE, out.width = '100%', fig.align='center'}
knitr::include_graphics("Assets/p14fig30.png")
```

### Local Wellbeing Indicators
Commissioned by ONS and Public Health England, the new Local Wellbeing Indicator Set was developed by the What Works Wellbeing and Happy City think-tanks, and was first published at the end of 2017 _[@WWW2017]_.  Designed to capture a holistic overview of local wellbeing and its determinants, the 23 indicators have deliberately _not_ been combined into a single index, as the authors feel it is more important for local policy-makers to understand where the gaps and challenges lie.

In Figure \@ref(fig:wellchart), Blackburn with Darwen’s score on each indicator is compared with the England average. If the bar points inwards from the ‘England’ circle, Blackburn with Darwen is performing less well than England, and if it points outwards, it is performing better.

```{r wellchart, fig.cap='Local Wellbeing Indicators for Blackburn with Darwen', echo = FALSE, out.width = '100%', fig.align='center'}
knitr::include_graphics("Assets/p15fig31.png")
```

#### Positive signs
It is clear that Blackburn with Darwen scores below average on the majority of indicators, many of which are picked up on elsewhere in this document. However, there are some notable exceptions. In the 2014 ‘What about YOUth?’ survey, the borough’s children were less likely than average to report low life satisfaction. Blackburn with Darwen has better than average Air Quality (according to the 2015 Indices of Deprivation), and a favourable RSA ‘Heritage Index’ - built up of over 100 different indicators, covering everything from battlefields, to museums, to local delicacies.

It is striking that the borough performs better than average on both indicators in the ‘Social Relationships’ domain (shown in pink in Figure \@ref(fig:wellchart)). When social care users are asked whether they have as much social contact as they would like, Blackburn with Darwen returns some of the best results in the country. It also has a relatively low ‘Social Fragmentation Index’, which is a census-based measure of the extent to which people live alone, move frequently, and/or live in private rented accommodation.
